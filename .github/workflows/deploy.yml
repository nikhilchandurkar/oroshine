name: Deploy to Production

on:
  workflow_run:
    workflows: ["Build Docker Image"]
    branches: [ main, master ]
    types: [ completed ]
  workflow_dispatch:

jobs:
  check-build:
    name: Check Build Status
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: Verify build result
        id: check
        run: |
          # Manual trigger â†’ always deploy
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Deploy only if build succeeded
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Build succeeded. Proceeding with deployment."
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Build failed. Skipping deployment."
          fi

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: check-build
    if: needs.check-build.outputs.should_deploy == 'true'

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_SSH_USER }}
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            cd /home/${{ secrets.EC2_SSH_USER }}/oroshine

            echo "ğŸ” Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            echo "ğŸ“¥ Pulling latest image..."
            docker-compose pull web

            echo "ğŸ”„ Restarting containers..."
            docker-compose up -d --remove-orphans

            echo "ğŸ§¹ Cleaning old images..."
            docker image prune -af --filter "until=240h"

            echo "âœ… Deployment completed successfully!"
