name: Test Suite

on:
  push:
    branches: [ main, develop, staging,master ]
  pull_request:
    branches: [ main, develop,master  ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pylint

      - name: Run Black (code formatting check)
        run: |
          black --check --diff .
        continue-on-error: true

      - name: Run isort (import sorting check)
        run: |
          isort --check-only --diff .
        continue-on-error: true

      - name: Run Flake8 (linting)
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run Pylint
        run: |
          pylint --load-plugins=pylint_django --django-settings-module=oroshine.settings $(git ls-files '*.py')
        continue-on-error: true

  test:
    name: Django Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_oroshine
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client libpq-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov pytest-xdist coverage

      - name: Download static libraries
        run: |
          chmod +x download_static_libs.sh
          ./download_static_libs.sh

      - name: Run migrations
        env:
          DATABASE_ENGINE: django.db.backends.postgresql
          DATABASE_NAME: test_oroshine
          DATABASE_USER: test_user
          DATABASE_PASSWORD: test_password
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: False
          ALLOWED_HOSTS: localhost,127.0.0.1
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          python manage.py migrate --noinput

      - name: Run Django unit tests
        env:
          DATABASE_ENGINE: django.db.backends.postgresql
          DATABASE_NAME: test_oroshine
          DATABASE_USER: test_user
          DATABASE_PASSWORD: test_password
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: False
          ALLOWED_HOSTS: localhost,127.0.0.1
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          # Run with pytest for better output
          pytest --cov=. --cov-report=xml --cov-report=html --cov-report=term-missing -v --maxfail=5

      - name: Run Django check
        env:
          SECRET_KEY: test-secret-key-for-ci
          DATABASE_ENGINE: django.db.backends.postgresql
          DATABASE_NAME: test_oroshine
          DATABASE_USER: test_user
          DATABASE_PASSWORD: test_password
          DATABASE_HOST: localhost
        run: |
          python manage.py check --deploy

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

      - name: Archive coverage results
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build Docker image
        run: |
          docker build -t oroshine:test .

      - name: Run integration tests with Docker Compose
        run: |
          # Create minimal test docker-compose
          cat > docker-compose.test.yml <<EOF
          version: '3.8'
          services:
            postgres:
              image: postgres:15-alpine
              environment:
                POSTGRES_DB: test_db
                POSTGRES_USER: test_user
                POSTGRES_PASSWORD: test_pass
            redis:
              image: redis:7-alpine
            web:
              image: oroshine:test
              environment:
                DATABASE_HOST: postgres
                DATABASE_NAME: test_db
                DATABASE_USER: test_user
                DATABASE_PASSWORD: test_pass
                REDIS_HOST: redis
                SECRET_KEY: test-key
                ALLOWED_HOSTS: "*"
              depends_on:
                - postgres
                - redis
          EOF
          
          docker-compose -f docker-compose.test.yml up -d
          sleep 20
          
          # Check if services are healthy
          docker-compose -f docker-compose.test.yml ps
          
          # Cleanup
          docker-compose -f docker-compose.test.yml down -v

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.lint.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.integration-test.result }}" == "failure" ]; then
            echo "❌ Tests failed"
            exit 1
          else
            echo "✅ All tests passed"
          fi